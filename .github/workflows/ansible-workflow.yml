name: Deploy and Collect VM Info with Ansible

on:
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰

jobs:
  deploy:
    runs-on: self-hosted  # GitHub Actions ì‹¤í–‰ ì„œë²„

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Install Required Tools
        run: |
          echo "ðŸ”§ í•„ìš”í•œ ë„êµ¬ ì„¤ì¹˜ í™•ì¸ ì¤‘..."
          # sshpass í™•ì¸ ë° ì„¤ì¹˜ (ë¹„ë°€ë²ˆí˜¸ ìžë™í™”ìš©)
          if ! command -v sshpass &> /dev/null; then
            echo "âš ï¸ sshpass ì„¤ì¹˜ ì¤‘..."
            sudo yum install -y sshpass
          else
            echo "âœ… sshpassê°€ ì´ë¯¸ ì„¤ì¹˜ë˜ì–´ ìžˆìŠµë‹ˆë‹¤."
          fi
          
          # PostgreSQL í´ë¼ì´ì–¸íŠ¸ í™•ì¸ ë° ì„¤ì¹˜
          if ! command -v psql &> /dev/null; then
            echo "âš ï¸ PostgreSQL í´ë¼ì´ì–¸íŠ¸ ì„¤ì¹˜ ì¤‘..."
            sudo yum install -y postgresql
          else
            echo "âœ… PostgreSQL í´ë¼ì´ì–¸íŠ¸ê°€ ì´ë¯¸ ì„¤ì¹˜ë˜ì–´ ìžˆìŠµë‹ˆë‹¤."
          fi

      - name: Set Environment Variables
        run: |
          echo "DB_PASSWORD=soldesk1." >> $GITHUB_ENV
          echo "AWX_PASSWORD=redhat" >> $GITHUB_ENV
          echo "DB_SERVER=192.168.60.64" >> $GITHUB_ENV
          echo "ANSIBLE_MASTER=192.168.50.11" >> $GITHUB_ENV
          echo "TEMPLATE_PATH=/var/lib/pgsql/data/service_templates/ansible" >> $GITHUB_ENV

      - name: Modify Ansible Deployment Script
        run: |
          echo "ðŸ”§ Ansible ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ìƒì„± ì¤‘..."
          
          # ê¸°ì¡´ ìŠ¤í¬ë¦½íŠ¸ ë¬¸ì œë¥¼ ìš°íšŒí•˜ëŠ” ìƒˆ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
          cat > /tmp/custom_deploy.sh << 'EOF'
          #!/bin/bash

          # ë¡œê·¸ íŒŒì¼ ì„¤ì • (awx ì‚¬ìš©ìžê°€ ì“¸ ìˆ˜ ìžˆëŠ” ìœ„ì¹˜ë¡œ ë³€ê²½)
          LOGFILE="/tmp/ansible_deployment-$(date +%Y%m%d-%H%M%S).log"

          echo "Starting Web Application Deployment with Ansible..." | tee -a $LOGFILE

          # í˜„ìž¬ ë””ë ‰í† ë¦¬ì˜ ìƒëŒ€ ê²½ë¡œë¥¼ ì‚¬ìš©
          ansible-playbook -i ./inventory/hosts ./playbooks/deployment.yml -v | tee -a $LOGFILE

          # ê²°ê³¼ í™•ì¸
          if [ $? -eq 0 ]; then
              echo "Deployment completed successfully!" | tee -a $LOGFILE
          else
              echo "Deployment failed. Check the logs for more information." | tee -a $LOGFILE
              exit 1
          fi

          echo "You can access the application at http://$(hostname -I | awk '{print $1}')" | tee -a $LOGFILE
          EOF
          
          chmod +x /tmp/custom_deploy.sh

      - name: Create Temporary Directories
        run: |
          echo "ðŸ”§ ìž„ì‹œ ë””ë ‰í† ë¦¬ ìƒì„± ì¤‘..."
          mkdir -p /tmp/ansible-files/{inventory,playbooks,scripts}
          mkdir -p /tmp/vm-info
          
          # ë§ˆìŠ¤í„° ì„œë²„ì— ìž„ì‹œ ë””ë ‰í† ë¦¬ ìƒì„±
          sshpass -p "${{ env.AWX_PASSWORD }}" ssh -o StrictHostKeyChecking=no awx@${{ env.ANSIBLE_MASTER }} "mkdir -p /tmp/ansible-files/{inventory,playbooks,scripts} /tmp/vm-info"

      - name: Create Test Ansible Files
        run: |
          echo "ðŸ”§ í…ŒìŠ¤íŠ¸ìš© Ansible íŒŒì¼ ìƒì„± ì¤‘..."
          
          # ê°„ë‹¨í•œ ì¸ë²¤í† ë¦¬ íŒŒì¼ ìƒì„±
          cat > /tmp/ansible-files/inventory/hosts << EOF
          [web_servers]
          localhost ansible_connection=local

          [database_servers]
          localhost ansible_connection=local
          EOF
          
          # ê°„ë‹¨í•œ í”Œë ˆì´ë¶ íŒŒì¼ ìƒì„±
          cat > /tmp/ansible-files/playbooks/deployment.yml << EOF
          ---
          - name: í…ŒìŠ¤íŠ¸ ë°°í¬
            hosts: localhost
            connection: local
            tasks:
              - name: í…ŒìŠ¤íŠ¸ íƒœìŠ¤í¬
                debug:
                  msg: "í…ŒìŠ¤íŠ¸ ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì‹¤í–‰ë˜ì—ˆìŠµë‹ˆë‹¤."
          EOF

      - name: Copy Ansible Files to Master Server
        run: |
          echo "ðŸš€ Ansible íŒŒì¼ì„ ë§ˆìŠ¤í„° ì„œë²„ë¡œ ë³µì‚¬ ì¤‘..."
          
          # ìˆ˜ì •ëœ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ë³µì‚¬
          sshpass -p "${{ env.AWX_PASSWORD }}" scp -o StrictHostKeyChecking=no /tmp/custom_deploy.sh awx@${{ env.ANSIBLE_MASTER }}:/tmp/ansible-files/scripts/deploy.sh
          
          # ìƒì„±í•œ Ansible íŒŒì¼ë“¤ ë³µì‚¬
          sshpass -p "${{ env.AWX_PASSWORD }}" scp -o StrictHostKeyChecking=no -r /tmp/ansible-files/inventory/* awx@${{ env.ANSIBLE_MASTER }}:/tmp/ansible-files/inventory/
          sshpass -p "${{ env.AWX_PASSWORD }}" scp -o StrictHostKeyChecking=no -r /tmp/ansible-files/playbooks/* awx@${{ env.ANSIBLE_MASTER }}:/tmp/ansible-files/playbooks/

      - name: Create VM Info Collection Playbook
        run: |
          echo "ðŸ”§ VM ì •ë³´ ìˆ˜ì§‘ í”Œë ˆì´ë¶ ìƒì„± ì¤‘..."
          
          # VM ì •ë³´ ìˆ˜ì§‘ìš© Ansible í”Œë ˆì´ë¶ ìƒì„±
          cat > /tmp/vm-info/collect_vm_info.yml << EOF
          ---
          - name: ì„œë²„ ì •ë³´ ìˆ˜ì§‘
            hosts: all
            gather_facts: yes
            tasks:
              - name: ì‹œìŠ¤í…œ ì •ë³´ ìˆ˜ì§‘
                setup:

              - name: VM ì •ë³´ ì €ìž¥
                delegate_to: localhost
                vars:
                  ansible_connection: local
                ansible.builtin.copy:
                  content: |
                    {
                      "hostname": "{{ ansible_hostname }}",
                      "ip_address": "{{ ansible_default_ipv4.address | default('unknown') }}",
                      "os_type": "{{ ansible_distribution }} {{ ansible_distribution_version }}",
                      "cpu_cores": {{ ansible_processor_cores | default(1) }},
                      "memory_gb": {{ (ansible_memtotal_mb / 1024) | round | int | default(2) }},
                      "storage_gb": {{ (ansible_mounts[0].size_total / 1024 / 1024 / 1024) | round | int | default(20) }},
                      "status": "running"
                    }
                  dest: "/tmp/vm-info/{{ ansible_hostname }}.json"
                  mode: '0644'
          EOF
          
          # VM ì •ë³´ ìˆ˜ì§‘ í”Œë ˆì´ë¶ì„ ë§ˆìŠ¤í„° ì„œë²„ë¡œ ë³µì‚¬
          sshpass -p "${{ env.AWX_PASSWORD }}" scp -o StrictHostKeyChecking=no /tmp/vm-info/collect_vm_info.yml awx@${{ env.ANSIBLE_MASTER }}:/tmp/vm-info/

      - name: Execute Ansible Deployment Script
        run: |
          echo "ðŸš€ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì¤‘..."
          
          # í˜„ìž¬ ë””ë ‰í† ë¦¬ë¥¼ ë³€ê²½í•´ì„œ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ (ê²½ë¡œ ë¬¸ì œ í•´ê²°)
          sshpass -p "${{ env.AWX_PASSWORD }}" ssh -o StrictHostKeyChecking=no awx@${{ env.ANSIBLE_MASTER }} "cd /tmp/ansible-files && bash ./scripts/deploy.sh"
          
          DEPLOYMENT_STATUS=$?
          if [ $DEPLOYMENT_STATUS -eq 0 ]; then
            echo "âœ… ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬ì— ì„±ê³µí–ˆìŠµë‹ˆë‹¤!"
          else
            echo "âŒ ë°°í¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìƒíƒœ ì½”ë“œ: $DEPLOYMENT_STATUS"
            exit $DEPLOYMENT_STATUS
          fi

      - name: Run VM Info Collection Playbook
        run: |
          echo "ðŸ” VM ì •ë³´ ìˆ˜ì§‘ í”Œë ˆì´ë¶ ì‹¤í–‰ ì¤‘..."
          
          # VM ì •ë³´ ìˆ˜ì§‘ í”Œë ˆì´ë¶ ì‹¤í–‰ (ì¸ë²¤í† ë¦¬ ê²½ë¡œ ìˆ˜ì •)
          sshpass -p "${{ env.AWX_PASSWORD }}" ssh -o StrictHostKeyChecking=no awx@${{ env.ANSIBLE_MASTER }} "cd /tmp/ansible-files && ansible-playbook -i ./inventory/hosts /tmp/vm-info/collect_vm_info.yml"

      - name: Fetch VM Info JSON Files
        run: |
          echo "ðŸ“¤ ìˆ˜ì§‘ëœ VM ì •ë³´ ê°€ì ¸ì˜¤ëŠ” ì¤‘..."
          mkdir -p /tmp/vm-info-results
          sshpass -p "${{ env.AWX_PASSWORD }}" scp -o StrictHostKeyChecking=no -r awx@${{ env.ANSIBLE_MASTER }}:/tmp/vm-info/*.json /tmp/vm-info-results/

      - name: Update Database with VM Information
        run: |
          echo "ðŸ’¾ VM ì •ë³´ DB ì—…ë°ì´íŠ¸ ì¤‘..."
          # ì—¬ê¸°ì— DB ì—…ë°ì´íŠ¸ ì½”ë“œ ì¶”ê°€ (ê¸°ì¡´ ì½”ë“œ ìœ ì§€)
