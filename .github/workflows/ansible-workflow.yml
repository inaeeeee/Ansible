name: Deploy and Collect VM Info with Ansible

on:
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰

jobs:
  deploy:
    runs-on: self-hosted  # GitHub Actions ì‹¤í–‰ ì„œë²„

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Install Required Tools
        run: |
          echo "ğŸ”§ í•„ìš”í•œ ë„êµ¬ ì„¤ì¹˜ í™•ì¸ ì¤‘..."
          # sshpass í™•ì¸ ë° ì„¤ì¹˜ (ë¹„ë°€ë²ˆí˜¸ ìë™í™”ìš©)
          if ! command -v sshpass &> /dev/null; then
            echo "âš ï¸ sshpass ì„¤ì¹˜ ì¤‘..."
            sudo yum install -y sshpass
          else
            echo "âœ… sshpassê°€ ì´ë¯¸ ì„¤ì¹˜ë˜ì–´ ìˆìŠµë‹ˆë‹¤."
          fi
          
          # PostgreSQL í´ë¼ì´ì–¸íŠ¸ í™•ì¸ ë° ì„¤ì¹˜
          if ! command -v psql &> /dev/null; then
            echo "âš ï¸ PostgreSQL í´ë¼ì´ì–¸íŠ¸ ì„¤ì¹˜ ì¤‘..."
            sudo yum install -y postgresql
          else
            echo "âœ… PostgreSQL í´ë¼ì´ì–¸íŠ¸ê°€ ì´ë¯¸ ì„¤ì¹˜ë˜ì–´ ìˆìŠµë‹ˆë‹¤."
          fi

      - name: Set Environment Variables
        run: |
          echo "DB_PASSWORD=soldesk1." >> $GITHUB_ENV
          echo "AWX_PASSWORD=redhat" >> $GITHUB_ENV
          echo "DB_SERVER=192.168.60.64" >> $GITHUB_ENV
          echo "ANSIBLE_MASTER=192.168.50.11" >> $GITHUB_ENV
          echo "ANSIBLE_PATH=/tmp/ansible-files" >> $GITHUB_ENV
          echo "DB_ANSIBLE_PATH=/var/lib/pgsql/data/service_templates/ansible" >> $GITHUB_ENV

      - name: Check Ansible Files on Master Server
        run: |
          echo "ğŸ” ë§ˆìŠ¤í„° ì„œë²„ì˜ Ansible íŒŒì¼ êµ¬ì¡° í™•ì¸ ì¤‘..."
          
          # ë§ˆìŠ¤í„° ì„œë²„ì˜ Ansible íŒŒì¼ êµ¬ì¡° í™•ì¸
          sshpass -p "${{ env.AWX_PASSWORD }}" ssh -o StrictHostKeyChecking=no awx@${{ env.ANSIBLE_MASTER }} "
            echo 'í˜„ì¬ Ansible íŒŒì¼ êµ¬ì¡°:'
            ls -la ${{ env.ANSIBLE_PATH }}/
            
            echo 'ì¸ë²¤í† ë¦¬ íŒŒì¼ ë‚´ìš©:'
            cat ${{ env.ANSIBLE_PATH }}/inventory/hosts
            
            echo 'ansible.cfg íŒŒì¼ ë‚´ìš©:'
            cat ${{ env.ANSIBLE_PATH }}/ansible.cfg
          " || echo "ì¼ë¶€ íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤."

      - name: Copy Ansible Files from DB Server (Optional)
        run: |
          echo "ğŸš€ DB ì„œë²„ì—ì„œ ì—…ë°ì´íŠ¸ëœ íŒŒì¼ í™•ì¸ ë° ë³µì‚¬ ì¤‘..."
          
          # DB ì„œë²„ì—ì„œ ì—…ë°ì´íŠ¸ëœ íŒŒì¼ì´ ìˆëŠ”ì§€ í™•ì¸í•˜ê³  í•„ìš”ì‹œ ë³µì‚¬
          # ì´ ë‹¨ê³„ëŠ” ì„ íƒì ìœ¼ë¡œ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
          
          # ë¡œì»¬ ì„ì‹œ ë””ë ‰í† ë¦¬ ìƒì„±
          mkdir -p /tmp/ansible-update
          
          # DB ì„œë²„ì—ì„œ ì—…ë°ì´íŠ¸ëœ í”Œë ˆì´ë¶ì´ë‚˜ ìŠ¤í¬ë¦½íŠ¸ë§Œ ê°€ì ¸ì˜¤ê¸°
          sshpass -p "${{ env.DB_PASSWORD }}" scp -o StrictHostKeyChecking=no -r postgres@${{ env.DB_SERVER }}:${{ env.DB_ANSIBLE_PATH }}/playbooks/* /tmp/ansible-update/ || echo "í”Œë ˆì´ë¶ ë³µì‚¬ ì‹¤íŒ¨ ë˜ëŠ” íŒŒì¼ ì—†ìŒ"
          
          # ì—…ë°ì´íŠ¸ëœ íŒŒì¼ì´ ìˆìœ¼ë©´ ë§ˆìŠ¤í„° ì„œë²„ë¡œ ë³µì‚¬
          if [ "$(ls -A /tmp/ansible-update)" ]; then
            echo "âœ… ì—…ë°ì´íŠ¸ëœ íŒŒì¼ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤. ë§ˆìŠ¤í„° ì„œë²„ë¡œ ë³µì‚¬í•©ë‹ˆë‹¤."
            sshpass -p "${{ env.AWX_PASSWORD }}" scp -o StrictHostKeyChecking=no -r /tmp/ansible-update/* awx@${{ env.ANSIBLE_MASTER }}:${{ env.ANSIBLE_PATH }}/playbooks/
          else
            echo "âœ… ì—…ë°ì´íŠ¸í•  íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. ê¸°ì¡´ íŒŒì¼ì„ ì‚¬ìš©í•©ë‹ˆë‹¤."
          fi

      - name: Verify Deployment Playbook
        run: |
          echo "ğŸ” ë°°í¬ í”Œë ˆì´ë¶ í™•ì¸ ì¤‘..."
          
          # ë°°í¬ í”Œë ˆì´ë¶ì´ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
          sshpass -p "${{ env.AWX_PASSWORD }}" ssh -o StrictHostKeyChecking=no awx@${{ env.ANSIBLE_MASTER }} "
            if [ -f ${{ env.ANSIBLE_PATH }}/deployment.yml ]; then
              echo 'âœ… ë°°í¬ í”Œë ˆì´ë¶ì´ ì¡´ì¬í•©ë‹ˆë‹¤.'
              echo 'í”Œë ˆì´ë¶ ë‚´ìš©:'
              cat ${{ env.ANSIBLE_PATH }}/deployment.yml
            else
              echo 'âš ï¸ ë°°í¬ í”Œë ˆì´ë¶ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ê¸°ë³¸ í”Œë ˆì´ë¶ì„ ìƒì„±í•©ë‹ˆë‹¤.'
              cat > ${{ env.ANSIBLE_PATH }}/deployment.yml << 'EOL'
          ---
          - name: ê¸°ë³¸ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
            hosts: localhost
            connection: local
            tasks:
              - name: ê¸°ë³¸ ë°°í¬ ì‹œì‘
                debug:
                  msg: 'ë™ì  ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ê°€ ì—†ì–´ ê¸°ë³¸ ë°°í¬ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.'

          - name: Nginx ì›¹ ì„œë²„ êµ¬ì„±
            hosts: webservers
            become: yes
            tasks:
              - name: Nginx ì„¤ì¹˜
                package:
                  name: nginx
                  state: present
                ignore_errors: yes

              - name: Nginx ì„œë¹„ìŠ¤ ì‹œì‘ ë° í™œì„±í™”
                service:
                  name: nginx
                  state: started
                  enabled: yes
                ignore_errors: yes

              - name: ê¸°ë³¸ ì›¹ í˜ì´ì§€ ìƒì„±
                copy:
                  content: |
                    <!DOCTYPE html>
                    <html>
                    <head>
                      <title>Ansible ë°°í¬ í…ŒìŠ¤íŠ¸</title>
                    </head>
                    <body>
                      <h1>Ansibleë¡œ ë°°í¬ëœ ì›¹ ì„œë²„ì…ë‹ˆë‹¤</h1>
                      <p>í˜¸ìŠ¤íŠ¸ëª…: {{ ansible_hostname }}</p>
                      <p>IP ì£¼ì†Œ: {{ ansible_default_ipv4.address }}</p>
                      <p>ë°°í¬ ì‹œê°„: {{ ansible_date_time.iso8601 }}</p>
                    </body>
                    </html>
                  dest: /usr/share/nginx/html/index.html
                ignore_errors: yes
          EOL
            fi
            
            # ì¸ë²¤í† ë¦¬ íŒŒì¼ í™•ì¸ ë° ìƒì„±
            if [ ! -f ${{ env.ANSIBLE_PATH }}/inventory/hosts ]; then
              echo 'âš ï¸ ì¸ë²¤í† ë¦¬ íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ê¸°ë³¸ ì¸ë²¤í† ë¦¬ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.'
              mkdir -p ${{ env.ANSIBLE_PATH }}/inventory
              cat > ${{ env.ANSIBLE_PATH }}/inventory/hosts << 'EOL'
          [webservers]
          web-server1 ansible_host=192.168.50.13 ansible_user=awx ansible_ssh_pass=redhat ansible_sudo_pass=redhat
          web-server2 ansible_host=192.168.50.14 ansible_user=awx ansible_ssh_pass=redhat ansible_sudo_pass=redhat

          [dbservers]
          db-server ansible_host=192.168.50.15 ansible_user=awx ansible_ssh_pass=redhat ansible_sudo_pass=redhat

          [all:vars]
          ansible_connection=ssh
          ansible_ssh_common_args='-o StrictHostKeyChecking=no'
          EOL
            fi
            
            # ansible.cfg íŒŒì¼ í™•ì¸ ë° ìƒì„±
            if [ ! -f ${{ env.ANSIBLE_PATH }}/ansible.cfg ]; then
              echo 'âš ï¸ ansible.cfg íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ê¸°ë³¸ ì„¤ì • íŒŒì¼ì„ ìƒì„±í•©ë‹ˆë‹¤.'
              cat > ${{ env.ANSIBLE_PATH }}/ansible.cfg << 'EOL'
          [defaults]
          host_key_checking = False
          remote_user = awx
          
          [ssh_connection]
          scp_if_ssh = True
          EOL
            fi
          "
     
      - name: Execute Ansible Deployment Playbook
        run: |
          echo "ğŸš€ Ansible ë°°í¬ í”Œë ˆì´ë¶ ì‹¤í–‰ ì¤‘..."
          
          # ë§ˆìŠ¤í„° ì„œë²„ì—ì„œ ì§ì ‘ Ansible í”Œë ˆì´ë¶ ì‹¤í–‰
          sshpass -p "${{ env.AWX_PASSWORD }}" ssh -o StrictHostKeyChecking=no awx@${{ env.ANSIBLE_MASTER }} "
            cd ${{ env.ANSIBLE_PATH }} && 
            ansible-playbook deployment.yml -v
          "
          
          DEPLOYMENT_STATUS=$?
          if [ $DEPLOYMENT_STATUS -eq 0 ]; then
            echo "âœ… ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬ì— ì„±ê³µí–ˆìŠµë‹ˆë‹¤!"
          else
            echo "âš ï¸ ë°°í¬ ì¤‘ ì¼ë¶€ ì‘ì—…ì´ ì‹¤íŒ¨í–ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ìƒíƒœ ì½”ë“œ: $DEPLOYMENT_STATUS"
            echo "ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”."
          fi

      - name: Create VM Info Collection Playbook
        run: |
          echo "ğŸ”§ VM ì •ë³´ ìˆ˜ì§‘ í”Œë ˆì´ë¶ ìƒì„± ì¤‘..."
          
          # VM ì •ë³´ ìˆ˜ì§‘ìš© Ansible í”Œë ˆì´ë¶ ìƒì„±
          cat > /tmp/collect_vm_info.yml << EOF
          ---
          - name: ì„œë²„ ì •ë³´ ìˆ˜ì§‘
            hosts: all
            gather_facts: yes
            tasks:
              - name: ì‹œìŠ¤í…œ ì •ë³´ ìˆ˜ì§‘
                setup:

              - name: VM ì •ë³´ ì €ì¥
                delegate_to: localhost
                vars:
                  ansible_connection: local
                ansible.builtin.copy:
                  content: |
                    {
                      "hostname": "{{ ansible_hostname }}",
                      "ip_address": "{{ ansible_default_ipv4.address | default('unknown') }}",
                      "os_type": "{{ ansible_distribution }} {{ ansible_distribution_version }}",
                      "cpu_cores": {{ ansible_processor_cores | default(1) }},
                      "memory_gb": {{ (ansible_memtotal_mb / 1024) | round | int | default(2) }},
                      "storage_gb": {{ (ansible_mounts[0].size_total / 1024 / 1024 / 1024) | round | int | default(20) }},
                      "status": "running"
                    }
                  dest: "/tmp/vm-info/{{ ansible_hostname }}.json"
                  mode: '0644'
          EOF
          
          # ë§ˆìŠ¤í„° ì„œë²„ì— VM ì •ë³´ í”Œë ˆì´ë¶ ë³µì‚¬ ë° ë””ë ‰í† ë¦¬ ìƒì„±
          sshpass -p "${{ env.AWX_PASSWORD }}" ssh -o StrictHostKeyChecking=no awx@${{ env.ANSIBLE_MASTER }} "mkdir -p /tmp/vm-info"
          sshpass -p "${{ env.AWX_PASSWORD }}" scp -o StrictHostKeyChecking=no /tmp/collect_vm_info.yml awx@${{ env.ANSIBLE_MASTER }}:${{ env.ANSIBLE_PATH }}/collect_vm_info.yml

      - name: Run VM Info Collection Playbook
        run: |
          echo "ğŸ” VM ì •ë³´ ìˆ˜ì§‘ í”Œë ˆì´ë¶ ì‹¤í–‰ ì¤‘..."
          
          # VM ì •ë³´ ìˆ˜ì§‘ í”Œë ˆì´ë¶ ì‹¤í–‰
          sshpass -p "${{ env.AWX_PASSWORD }}" ssh -o StrictHostKeyChecking=no awx@${{ env.ANSIBLE_MASTER }} "
            cd ${{ env.ANSIBLE_PATH }} && 
            ansible-playbook collect_vm_info.yml -v
          "

      - name: Fetch VM Info JSON Files
        run: |
          echo "ğŸ“¤ ìˆ˜ì§‘ëœ VM ì •ë³´ ê°€ì ¸ì˜¤ëŠ” ì¤‘..."
          mkdir -p /tmp/vm-info-results
          sshpass -p "${{ env.AWX_PASSWORD }}" scp -o StrictHostKeyChecking=no -r awx@${{ env.ANSIBLE_MASTER }}:/tmp/vm-info/*.json /tmp/vm-info-results/ || echo "VM ì •ë³´ íŒŒì¼ì´ ì—†ê±°ë‚˜ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
          
          # ìˆ˜ì§‘ëœ VM ì •ë³´ í™•ì¸
          echo "ìˆ˜ì§‘ëœ VM ì •ë³´ íŒŒì¼ ëª©ë¡:"
          ls -la /tmp/vm-info-results/ || echo "VM ì •ë³´ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."

      - name: Create Database Update Script
        run: |
          echo "ğŸ”§ DB ì—…ë°ì´íŠ¸ ìŠ¤í¬ë¦½íŠ¸ ìƒì„± ì¤‘..."
          
          # VM ì •ë³´ë¥¼ DBì— ì €ì¥í•˜ëŠ” ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
          cat > /tmp/update_db.py << EOF
          #!/usr/bin/env python3
          import os
          import json
          import glob
          import subprocess
          import datetime
          
          def get_workspace_id():
              """íšŒì‚¬ ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ID ì¡°íšŒ"""
              cmd = [
                  'psql', '-h', '192.168.60.64', '-p', '5432', '-U', 'postgres', 
                  '-d', 'solmakasedb', '-t', '-c', 
                  "SELECT id FROM companywworkspace LIMIT 1;"
              ]
              result = subprocess.run(cmd, capture_output=True, text=True, env=dict(os.environ, PGPASSWORD='soldesk1.'))
              return result.stdout.strip() or '1'  # ê¸°ë³¸ê°’ 1
          
          def save_vm_info(vm_data, workspace_id):
              """VM ì •ë³´ë¥¼ DBì— ì €ì¥"""
              hostname = vm_data['hostname']
              
              # ê¸°ì¡´ VM í™•ì¸
              check_sql = f"SELECT id FROM vm WHERE name = '{hostname}'"
              cmd = [
                  'psql', '-h', '192.168.60.64', '-p', '5432', '-U', 'postgres', 
                  '-d', 'solmakasedb', '-t', '-c', check_sql
              ]
              result = subprocess.run(cmd, capture_output=True, text=True, env=dict(os.environ, PGPASSWORD='soldesk1.'))
              vm_id = result.stdout.strip()
              
              now = datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")
              
              if vm_id:
                  # VM ì—…ë°ì´íŠ¸
                  update_sql = f"""
                  UPDATE vm SET 
                      os_type = '{vm_data['os_type']}',
                      cpu_cores = {vm_data['cpu_cores']},
                      memory_gb = {vm_data['memory_gb']},
                      storage_gb = {vm_data['storage_gb']},
                      status = '{vm_data['status']}',
                      total_usage_hrs = total_usage_hrs + 1
                  WHERE id = {vm_id}
                  """
                  cmd = [
                      'psql', '-h', '192.168.60.64', '-p', '5432', '-U', 'postgres', 
                      '-d', 'solmakasedb', '-c', update_sql
                  ]
                  subprocess.run(cmd, env=dict(os.environ, PGPASSWORD='soldesk1.'))
                  print(f"âœ… VM '{hostname}' ì •ë³´ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.")
              else:
                  # ìƒˆ VM ì¶”ê°€
                  insert_sql = f"""
                  INSERT INTO vm (
                      name, os_type, cpu_cores, memory_gb, storage_gb, 
                      status, total_usage_hrs, created_at, company_workspace_id
                  ) VALUES (
                      '{hostname}', '{vm_data['os_type']}', {vm_data['cpu_cores']}, 
                      {vm_data['memory_gb']}, {vm_data['storage_gb']}, '{vm_data['status']}', 
                      0, '{now}', {workspace_id}
                  ) RETURNING id
                  """
                  cmd = [
                      'psql', '-h', '192.168.60.64', '-p', '5432', '-U', 'postgres', 
                      '-d', 'solmakasedb', '-t', '-c', insert_sql
                  ]
                  result = subprocess.run(cmd, capture_output=True, text=True, env=dict(os.environ, PGPASSWORD='soldesk1.'))
                  new_vm_id = result.stdout.strip()
                  
                  # VM ë„¤íŠ¸ì›Œí¬ ì •ë³´ ì¶”ê°€
                  if new_vm_id:
                      network_sql = f"""
                      INSERT INTO vm_network (vm_id, ip_address, network_type)
                      VALUES ({new_vm_id}, '{vm_data['ip_address']}', 'internal')
                      """
                      cmd = [
                          'psql', '-h', '192.168.60.64', '-p', '5432', '-U', 'postgres', 
                          '-d', 'solmakasedb', '-c', network_sql
                      ]
                      subprocess.run(cmd, env=dict(os.environ, PGPASSWORD='soldesk1.'))
                      print(f"âœ… ìƒˆ VM '{hostname}' ë° ë„¤íŠ¸ì›Œí¬ ì •ë³´ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.")
          
          # ë©”ì¸ ì‹¤í–‰
          workspace_id = get_workspace_id()
          vm_files = glob.glob('/tmp/vm-info-results/*.json')
          
          if not vm_files:
              print("âš ï¸ ìˆ˜ì§‘ëœ VM ì •ë³´ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.")
              exit(0)
              
          print(f"ì´ {len(vm_files)}ê°œì˜ VM ì •ë³´ íŒŒì¼ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤.")
          for vm_file in vm_files:
              try:
                  with open(vm_file, 'r') as f:
                      vm_data = json.load(f)
                      save_vm_info(vm_data, workspace_id)
              except json.JSONDecodeError:
                  print(f"âŒ ì˜¤ë¥˜: {vm_file} íŒŒì¼ì„ íŒŒì‹±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
              except Exception as e:
                  print(f"âŒ ì˜¤ë¥˜ ë°œìƒ: {str(e)}")
          
          print("âœ… ëª¨ë“  VM ì •ë³´ ì²˜ë¦¬ ì™„ë£Œ")
          EOF
          
          chmod +x /tmp/update_db.py

      - name: Update Database with VM Information
        run: |
          echo "ğŸ’¾ VM ì •ë³´ DB ì—…ë°ì´íŠ¸ ì¤‘..."
          # JSON íŒŒì¼ì´ ìˆëŠ”ì§€ í™•ì¸
          if [ -z "$(ls -A /tmp/vm-info-results/*.json 2>/dev/null)" ]; then
            echo "âš ï¸ ìˆ˜ì§‘ëœ VM ì •ë³´ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤"
            exit 0
          fi
          
          # DB ì—…ë°ì´íŠ¸ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
          python3 /tmp/update_db.py
          
          echo "âœ… ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ì™„ë£Œ!"
