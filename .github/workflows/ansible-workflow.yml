name: Deploy and Collect VM Info with Ansible

on:
  workflow_dispatch:  # μλ™ μ‹¤ν–‰

jobs:
  deploy:
    runs-on: self-hosted  # GitHub Actions μ‹¤ν–‰ μ„λ²„

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Install Required Tools
        run: |
          echo "π”§ ν•„μ”ν• λ„κµ¬ μ„¤μΉ ν™•μΈ μ¤‘..."
          # sshpass ν™•μΈ λ° μ„¤μΉ (λΉ„λ°€λ²νΈ μλ™ν™”μ©)
          if ! command -v sshpass &> /dev/null; then
            echo "β οΈ sshpass μ„¤μΉ μ¤‘..."
            sudo yum install -y sshpass
          else
            echo "β… sshpassκ°€ μ΄λ―Έ μ„¤μΉλμ–΄ μμµλ‹λ‹¤."
          fi
          
          # PostgreSQL ν΄λΌμ΄μ–ΈνΈ ν™•μΈ λ° μ„¤μΉ
          if ! command -v psql &> /dev/null; then
            echo "β οΈ PostgreSQL ν΄λΌμ΄μ–ΈνΈ μ„¤μΉ μ¤‘..."
            sudo yum install -y postgresql
          else
            echo "β… PostgreSQL ν΄λΌμ΄μ–ΈνΈκ°€ μ΄λ―Έ μ„¤μΉλμ–΄ μμµλ‹λ‹¤."
          fi

      - name: Set Environment Variables
        run: |
          echo "DB_PASSWORD=soldesk1." >> $GITHUB_ENV
          echo "AWX_PASSWORD=redhat" >> $GITHUB_ENV
          echo "DB_SERVER=192.168.60.64" >> $GITHUB_ENV
          echo "ANSIBLE_MASTER=192.168.50.11" >> $GITHUB_ENV
          echo "ANSIBLE_PATH=/tmp/ansible-files" >> $GITHUB_ENV
          echo "DB_ANSIBLE_PATH=/var/lib/pgsql/data/service_templates/ansible" >> $GITHUB_ENV

      - name: Check Ansible Files on Master Server
        run: |
          echo "π” λ§μ¤ν„° μ„λ²„μ Ansible νμΌ κµ¬μ΅° ν™•μΈ μ¤‘..."
          
          # λ§μ¤ν„° μ„λ²„μ Ansible νμΌ κµ¬μ΅° ν™•μΈ
          sshpass -p "${{ env.AWX_PASSWORD }}" ssh -o StrictHostKeyChecking=no awx@${{ env.ANSIBLE_MASTER }} "
            echo 'ν„μ¬ Ansible νμΌ κµ¬μ΅°:'
            ls -la ${{ env.ANSIBLE_PATH }}/
            
            echo 'μΈλ²¤ν† λ¦¬ νμΌ λ‚΄μ©:'
            cat ${{ env.ANSIBLE_PATH }}/inventory/hosts
            
            echo 'ansible.cfg νμΌ λ‚΄μ©:'
            cat ${{ env.ANSIBLE_PATH }}/ansible.cfg
          "

      - name: Copy Ansible Files from DB Server (Optional)
        run: |
          echo "π€ DB μ„λ²„μ—μ„ μ—…λ°μ΄νΈλ νμΌ ν™•μΈ λ° λ³µμ‚¬ μ¤‘..."
          
          # DB μ„λ²„μ—μ„ μ—…λ°μ΄νΈλ νμΌμ΄ μλ”μ§€ ν™•μΈν•κ³  ν•„μ”μ‹ λ³µμ‚¬
          # μ΄ λ‹¨κ³„λ” μ„ νƒμ μΌλ΅ μ‹¤ν–‰ν•  μ μμµλ‹λ‹¤
          
          # λ΅μ»¬ μ„μ‹ λ””λ ‰ν† λ¦¬ μƒμ„±
          mkdir -p /tmp/ansible-update
          
          # DB μ„λ²„μ—μ„ μ—…λ°μ΄νΈλ ν”λ μ΄λ¶μ΄λ‚ μ¤ν¬λ¦½νΈλ§ κ°€μ Έμ¤κΈ°
          sshpass -p "${{ env.DB_PASSWORD }}" scp -o StrictHostKeyChecking=no -r postgres@${{ env.DB_SERVER }}:${{ env.DB_ANSIBLE_PATH }}/playbooks/* /tmp/ansible-update/ || echo "ν”λ μ΄λ¶ λ³µμ‚¬ μ‹¤ν¨ λλ” νμΌ μ—†μ"
          
          # μ—…λ°μ΄νΈλ νμΌμ΄ μμΌλ©΄ λ§μ¤ν„° μ„λ²„λ΅ λ³µμ‚¬
          if [ "$(ls -A /tmp/ansible-update)" ]; then
            echo "β… μ—…λ°μ΄νΈλ νμΌμ΄ λ°κ²¬λμ—μµλ‹λ‹¤. λ§μ¤ν„° μ„λ²„λ΅ λ³µμ‚¬ν•©λ‹λ‹¤."
            sshpass -p "${{ env.AWX_PASSWORD }}" scp -o StrictHostKeyChecking=no -r /tmp/ansible-update/* awx@${{ env.ANSIBLE_MASTER }}:${{ env.ANSIBLE_PATH }}/playbooks/
          else
            echo "β… μ—…λ°μ΄νΈν•  νμΌμ΄ μ—†μµλ‹λ‹¤. κΈ°μ΅΄ νμΌμ„ μ‚¬μ©ν•©λ‹λ‹¤."
          fi

      - name: Verify Deployment Playbook
        run: |
          echo "π” λ°°ν¬ ν”λ μ΄λ¶ ν™•μΈ μ¤‘..."
          
          # λ°°ν¬ ν”λ μ΄λ¶μ΄ μ΅΄μ¬ν•λ”μ§€ ν™•μΈ
          sshpass -p "${{ env.AWX_PASSWORD }}" ssh -o StrictHostKeyChecking=no awx@${{ env.ANSIBLE_MASTER }} "
     
      - name: Execute Ansible Deployment Playbook
        run: |
          echo "π€ Ansible λ°°ν¬ ν”λ μ΄λ¶ μ‹¤ν–‰ μ¤‘..."
          
          # λ§μ¤ν„° μ„λ²„μ—μ„ μ§μ ‘ Ansible ν”λ μ΄λ¶ μ‹¤ν–‰
          sshpass -p "${{ env.AWX_PASSWORD }}" ssh -o StrictHostKeyChecking=no awx@${{ env.ANSIBLE_MASTER }} "
            cd ${{ env.ANSIBLE_PATH }} && 
            ansible-playbook deployment.yml -v
          "
          
          DEPLOYMENT_STATUS=$?
          if [ $DEPLOYMENT_STATUS -eq 0 ]; then
            echo "β… μ• ν”λ¦¬μΌ€μ΄μ… λ°°ν¬μ— μ„±κ³µν–μµλ‹λ‹¤!"
          else
            echo "β οΈ λ°°ν¬ μ¤‘ μΌλ¶€ μ‘μ—…μ΄ μ‹¤ν¨ν–μ„ μ μμµλ‹λ‹¤. μƒνƒ μ½”λ“: $DEPLOYMENT_STATUS"
            echo "λ΅κ·Έλ¥Ό ν™•μΈν•μ„Έμ”."
          fi

      - name: Create VM Info Collection Playbook
        run: |
          echo "π”§ VM μ •λ³΄ μμ§‘ ν”λ μ΄λ¶ μƒμ„± μ¤‘..."
          
          # VM μ •λ³΄ μμ§‘μ© Ansible ν”λ μ΄λ¶ μƒμ„±
          cat > /tmp/collect_vm_info.yml << EOF
          ---
          - name: μ„λ²„ μ •λ³΄ μμ§‘
            hosts: all
            gather_facts: yes
            tasks:
              - name: μ‹μ¤ν… μ •λ³΄ μμ§‘
                setup:

              - name: VM μ •λ³΄ μ €μ¥
                delegate_to: localhost
                vars:
                  ansible_connection: local
                ansible.builtin.copy:
                  content: |
                    {
                      "hostname": "{{ ansible_hostname }}",
                      "ip_address": "{{ ansible_default_ipv4.address | default('unknown') }}",
                      "os_type": "{{ ansible_distribution }} {{ ansible_distribution_version }}",
                      "cpu_cores": {{ ansible_processor_cores | default(1) }},
                      "memory_gb": {{ (ansible_memtotal_mb / 1024) | round | int | default(2) }},
                      "storage_gb": {{ (ansible_mounts[0].size_total / 1024 / 1024 / 1024) | round | int | default(20) }},
                      "status": "running"
                    }
                  dest: "/tmp/vm-info/{{ ansible_hostname }}.json"
                  mode: '0644'
          EOF
          
          # λ§μ¤ν„° μ„λ²„μ— VM μ •λ³΄ ν”λ μ΄λ¶ λ³µμ‚¬ λ° λ””λ ‰ν† λ¦¬ μƒμ„±
          sshpass -p "${{ env.AWX_PASSWORD }}" ssh -o StrictHostKeyChecking=no awx@${{ env.ANSIBLE_MASTER }} "mkdir -p /tmp/vm-info"
          sshpass -p "${{ env.AWX_PASSWORD }}" scp -o StrictHostKeyChecking=no /tmp/collect_vm_info.yml awx@${{ env.ANSIBLE_MASTER }}:${{ env.ANSIBLE_PATH }}/collect_vm_info.yml

      - name: Run VM Info Collection Playbook
        run: |
          echo "π” VM μ •λ³΄ μμ§‘ ν”λ μ΄λ¶ μ‹¤ν–‰ μ¤‘..."
          
          # VM μ •λ³΄ μμ§‘ ν”λ μ΄λ¶ μ‹¤ν–‰
          sshpass -p "${{ env.AWX_PASSWORD }}" ssh -o StrictHostKeyChecking=no awx@${{ env.ANSIBLE_MASTER }} "
            cd ${{ env.ANSIBLE_PATH }} && 
            ansible-playbook collect_vm_info.yml -v
          "

      - name: Fetch VM Info JSON Files
        run: |
          echo "π“¤ μμ§‘λ VM μ •λ³΄ κ°€μ Έμ¤λ” μ¤‘..."
          mkdir -p /tmp/vm-info-results
          sshpass -p "${{ env.AWX_PASSWORD }}" scp -o StrictHostKeyChecking=no -r awx@${{ env.ANSIBLE_MASTER }}:/tmp/vm-info/*.json /tmp/vm-info-results/ || echo "VM μ •λ³΄ νμΌμ΄ μ—†κ±°λ‚ κ°€μ Έμ¤λ”λ° μ‹¤ν¨ν–μµλ‹λ‹¤."
          
          # μμ§‘λ VM μ •λ³΄ ν™•μΈ
          echo "μμ§‘λ VM μ •λ³΄ νμΌ λ©λ΅:"
          ls -la /tmp/vm-info-results/ || echo "VM μ •λ³΄ νμΌμ΄ μ—†μµλ‹λ‹¤."

      - name: Create Database Update Script
        run: |
          echo "π”§ DB μ—…λ°μ΄νΈ μ¤ν¬λ¦½νΈ μƒμ„± μ¤‘..."
          
          # VM μ •λ³΄λ¥Ό DBμ— μ €μ¥ν•λ” μ¤ν¬λ¦½νΈ μƒμ„±
          cat > /tmp/update_db.py << EOF
          #!/usr/bin/env python3
          import os
          import json
          import glob
          import subprocess
          import datetime
          
          def get_workspace_id():
              """νμ‚¬ μ›ν¬μ¤νμ΄μ¤ ID μ΅°ν"""
              cmd = [
                  'psql', '-h', '192.168.60.64', '-p', '5432', '-U', 'postgres', 
                  '-d', 'solmakasedb', '-t', '-c', 
                  "SELECT id FROM companywworkspace LIMIT 1;"
              ]
              result = subprocess.run(cmd, capture_output=True, text=True, env=dict(os.environ, PGPASSWORD='soldesk1.'))
              return result.stdout.strip() or '1'  # κΈ°λ³Έκ°’ 1
          
          def save_vm_info(vm_data, workspace_id):
              """VM μ •λ³΄λ¥Ό DBμ— μ €μ¥"""
              hostname = vm_data['hostname']
              
              # κΈ°μ΅΄ VM ν™•μΈ
              check_sql = f"SELECT id FROM vm WHERE name = '{hostname}'"
              cmd = [
                  'psql', '-h', '192.168.60.64', '-p', '5432', '-U', 'postgres', 
                  '-d', 'solmakasedb', '-t', '-c', check_sql
              ]
              result = subprocess.run(cmd, capture_output=True, text=True, env=dict(os.environ, PGPASSWORD='soldesk1.'))
              vm_id = result.stdout.strip()
              
              now = datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")
              
              if vm_id:
                  # VM μ—…λ°μ΄νΈ
                  update_sql = f"""
                  UPDATE vm SET 
                      os_type = '{vm_data['os_type']}',
                      cpu_cores = {vm_data['cpu_cores']},
                      memory_gb = {vm_data['memory_gb']},
                      storage_gb = {vm_data['storage_gb']},
                      status = '{vm_data['status']}',
                      total_usage_hrs = total_usage_hrs + 1
                  WHERE id = {vm_id}
                  """
                  cmd = [
                      'psql', '-h', '192.168.60.64', '-p', '5432', '-U', 'postgres', 
                      '-d', 'solmakasedb', '-c', update_sql
                  ]
                  subprocess.run(cmd, env=dict(os.environ, PGPASSWORD='soldesk1.'))
                  print(f"β… VM '{hostname}' μ •λ³΄κ°€ μ—…λ°μ΄νΈλμ—μµλ‹λ‹¤.")
              else:
                  # μƒ VM μ¶”κ°€
                  insert_sql = f"""
                  INSERT INTO vm (
                      name, os_type, cpu_cores, memory_gb, storage_gb, 
                      status, total_usage_hrs, created_at, company_workspace_id
                  ) VALUES (
                      '{hostname}', '{vm_data['os_type']}', {vm_data['cpu_cores']}, 
                      {vm_data['memory_gb']}, {vm_data['storage_gb']}, '{vm_data['status']}', 
                      0, '{now}', {workspace_id}
                  ) RETURNING id
                  """
                  cmd = [
                      'psql', '-h', '192.168.60.64', '-p', '5432', '-U', 'postgres', 
                      '-d', 'solmakasedb', '-t', '-c', insert_sql
                  ]
                  result = subprocess.run(cmd, capture_output=True, text=True, env=dict(os.environ, PGPASSWORD='soldesk1.'))
                  new_vm_id = result.stdout.strip()
                  
                  # VM λ„¤νΈμ›ν¬ μ •λ³΄ μ¶”κ°€
                  if new_vm_id:
                      network_sql = f"""
                      INSERT INTO vm_network (vm_id, ip_address, network_type)
                      VALUES ({new_vm_id}, '{vm_data['ip_address']}', 'internal')
                      """
                      cmd = [
                          'psql', '-h', '192.168.60.64', '-p', '5432', '-U', 'postgres', 
                          '-d', 'solmakasedb', '-c', network_sql
                      ]
                      subprocess.run(cmd, env=dict(os.environ, PGPASSWORD='soldesk1.'))
                      print(f"β… μƒ VM '{hostname}' λ° λ„¤νΈμ›ν¬ μ •λ³΄κ°€ μ¶”κ°€λμ—μµλ‹λ‹¤.")
          
          # λ©”μΈ μ‹¤ν–‰
          workspace_id = get_workspace_id()
          vm_files = glob.glob('/tmp/vm-info-results/*.json')
          
          if not vm_files:
              print("β οΈ μμ§‘λ VM μ •λ³΄ νμΌμ΄ μ—†μµλ‹λ‹¤.")
              exit(0)
              
          print(f"μ΄ {len(vm_files)}κ°μ VM μ •λ³΄ νμΌμ„ μ²λ¦¬ν•©λ‹λ‹¤.")
          for vm_file in vm_files:
              try:
                  with open(vm_file, 'r') as f:
                      vm_data = json.load(f)
                      save_vm_info(vm_data, workspace_id)
              except json.JSONDecodeError:
                  print(f"β μ¤λ¥: {vm_file} νμΌμ„ νμ‹±ν•  μ μ—†μµλ‹λ‹¤.")
              except Exception as e:
                  print(f"β μ¤λ¥ λ°μƒ: {str(e)}")
          
          print("β… λ¨λ“  VM μ •λ³΄ μ²λ¦¬ μ™„λ£")
          EOF
          
          chmod +x /tmp/update_db.py

      - name: Update Database with VM Information
        run: |
          echo "π’Ύ VM μ •λ³΄ DB μ—…λ°μ΄νΈ μ¤‘..."
          # JSON νμΌμ΄ μλ”μ§€ ν™•μΈ
          if [ -z "$(ls -A /tmp/vm-info-results/*.json 2>/dev/null)" ]; then
            echo "β οΈ μμ§‘λ VM μ •λ³΄ νμΌμ΄ μ—†μµλ‹λ‹¤"
            exit 0
          fi
          
          # DB μ—…λ°μ΄νΈ μ¤ν¬λ¦½νΈ μ‹¤ν–‰
          python3 /tmp/update_db.py
          
          echo "β… μ›ν¬ν”λ΅μ° μ‹¤ν–‰ μ™„λ£!"
