name: Deploy and Collect VM Info with Ansible

on:
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰

jobs:
  deploy:
    runs-on: self-hosted  # GitHub Actions ì‹¤í–‰ ì„œë²„

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Install PostgreSQL Client if needed
        run: |
          echo "ðŸ”§ PostgreSQL í´ë¼ì´ì–¸íŠ¸ ì„¤ì¹˜ í™•ì¸ ì¤‘..."
          if ! command -v psql &> /dev/null; then
            echo "âš ï¸ PostgreSQL í´ë¼ì´ì–¸íŠ¸ ì„¤ì¹˜ ì¤‘..."
            sudo yum install -y postgresql
          else
            echo "âœ… PostgreSQL í´ë¼ì´ì–¸íŠ¸ê°€ ì´ë¯¸ ì„¤ì¹˜ë˜ì–´ ìžˆìŠµë‹ˆë‹¤."
          fi

      - name: Setup PostgreSQL Authentication
        run: |
          echo "ðŸ”§ PostgreSQL ì¸ì¦ ì„¤ì • ì¤‘..."
          echo "192.168.60.64:5432:*:postgres:qaz123" > ~/.pgpass
          echo "192.168.60.65:5432:*:postgres:qaz123" >> ~/.pgpass
          echo "192.168.60.66:5432:*:postgres:qaz123" >> ~/.pgpass
          echo "192.168.60.67:5001:*:postgres:qaz123" >> ~/.pgpass
          chmod 600 ~/.pgpass

      - name: Fetch Ansible Deployment Info from PostgreSQL
        run: |
          echo "ðŸ” PostgreSQLì—ì„œ Ansible ë°°í¬ ì •ë³´ ì¡°íšŒ ì¤‘..."

          # HAProxy(5001)ì—ì„œ ë°ì´í„° ì¡°íšŒ ì‹œë„
          SERVICE_INFO=$(psql -h 192.168.60.67 -p 5001 -U postgres -d solmakasedb -t -w -c \
            "SELECT name, deploy_script FROM servicetemplate WHERE name = 'ansible';")

          # ê²°ê³¼ê°€ ì—†ìœ¼ë©´ ë‹¤ë¥¸ DB ì„œë²„ ì‹œë„
          if [[ -z "$SERVICE_INFO" ]]; then
            for DB_HOST in 192.168.60.64 192.168.60.65 192.168.60.66; do
              SERVICE_INFO=$(psql -h $DB_HOST -p 5432 -U postgres -d solmakasedb -t -w -c \
                "SELECT name, deploy_script FROM servicetemplate WHERE name = 'ansible';")
              
              if [[ ! -z "$SERVICE_INFO" ]]; then
                echo "âœ… $DB_HOSTì—ì„œ Ansible ì„œë¹„ìŠ¤ ì •ë³´ë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤."
                DB_SERVER=$DB_HOST
                break
              fi
            done
          else
            DB_SERVER="192.168.60.67"
            echo "âœ… HAProxyì—ì„œ Ansible ì„œë¹„ìŠ¤ ì •ë³´ë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤."
          fi

          if [[ -z "$SERVICE_INFO" ]]; then
            echo "âŒ Ansible ë°°í¬ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!"
            exit 1
          fi

          echo "âœ… Ansible ì„œë¹„ìŠ¤ ì •ë³´: $SERVICE_INFO"

          DEPLOY_SCRIPT=$(echo "$SERVICE_INFO" | awk -F '|' '{print $2}' | xargs)
          echo "ðŸ“Œ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ê²½ë¡œ: $DEPLOY_SCRIPT"

          # ì‚¬ìš©í•  ìˆ˜ ìžˆëŠ” DB ì„œë²„ ëª©ë¡
          DB_SERVERS=("192.168.60.64" "192.168.60.65" "192.168.60.66")
          SELECTED_DB_SERVER=""

          echo "ðŸ” ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ê°€ ì¡´ìž¬í•˜ëŠ” DB ì„œë²„ ì°¾ëŠ” ì¤‘..."

          # ì‹¤ì œë¡œ íŒŒì¼ì´ ì¡´ìž¬í•˜ëŠ” DB ì„œë²„ ì°¾ê¸°
          for DB_SERVER in "${DB_SERVERS[@]}"; do
              echo "ðŸ” $DB_SERVER í™•ì¸ ì¤‘..."
              if ssh -o StrictHostKeyChecking=no postgres@$DB_SERVER "test -f $DEPLOY_SCRIPT"; then
                  SELECTED_DB_SERVER=$DB_SERVER
                  echo "âœ… $DB_SERVERì—ì„œ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤."
                  break
              fi
          done

          # DB ì„œë²„ë¥¼ ì°¾ì§€ ëª»í•˜ë©´ ì˜¤ë¥˜ ë°œìƒ
          if [[ -z "$SELECTED_DB_SERVER" ]]; then
              echo "âŒ ì˜¤ë¥˜: ì–´ë–¤ DB ì„œë²„ì—ë„ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤!"
              exit 1
          fi

          # ì„ íƒëœ DB ì„œë²„ ì €ìž¥
          echo "SELECTED_DB_SERVER=$SELECTED_DB_SERVER" >> $GITHUB_ENV
          echo "DEPLOY_SCRIPT=$DEPLOY_SCRIPT" >> $GITHUB_ENV

          # Ansible í…œí”Œë¦¿ ë””ë ‰í† ë¦¬ ê²½ë¡œ ì¶”ì¶œ
          TEMPLATE_DIR=$(dirname $(dirname $DEPLOY_SCRIPT))
          echo "ANSIBLE_TEMPLATE_DIR=$TEMPLATE_DIR" >> $GITHUB_ENV

      - name: Create VM Info Collection Playbook
        run: |
          echo "ðŸ”§ VM ì •ë³´ ìˆ˜ì§‘ í”Œë ˆì´ë¶ ìƒì„± ì¤‘..."
          
          # ìž„ì‹œ ë””ë ‰í† ë¦¬ ìƒì„±
          mkdir -p /tmp/ansible-vminfo
          
          # VM ì •ë³´ ìˆ˜ì§‘ìš© Ansible í”Œë ˆì´ë¶ ìƒì„±
          cat > /tmp/ansible-vminfo/collect_vm_info.yml << EOF
          ---
          - name: ì„œë²„ ì •ë³´ ìˆ˜ì§‘
            hosts: all
            gather_facts: yes
            tasks:
              - name: ì‹œìŠ¤í…œ ì •ë³´ ìˆ˜ì§‘
                setup:

              - name: VM ì •ë³´ ì €ìž¥
                delegate_to: localhost
                vars:
                  ansible_connection: local
                ansible.builtin.copy:
                  content: |
                    {
                      "hostname": "{{ ansible_hostname }}",
                      "ip_address": "{{ ansible_default_ipv4.address | default('unknown') }}",
                      "os_type": "{{ ansible_distribution }} {{ ansible_distribution_version }}",
                      "cpu_cores": {{ ansible_processor_cores | default(1) }},
                      "memory_gb": {{ (ansible_memtotal_mb / 1024) | round | int | default(2) }},
                      "storage_gb": {{ (ansible_mounts[0].size_total / 1024 / 1024 / 1024) | round | int | default(20) }},
                      "status": "running"
                    }
                  dest: "/tmp/ansible-vminfo/{{ ansible_hostname }}.json"
                  mode: '0644'
          EOF
          
          # DB ì €ìž¥ìš© ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
          cat > /tmp/ansible-vminfo/save_to_db.py << EOF
          #!/usr/bin/env python3
          import os
          import json
          import glob
          import subprocess
          import datetime

          def get_workspace_id():
              """íšŒì‚¬ ì›Œí¬ìŠ¤íŽ˜ì´ìŠ¤ ID ì¡°íšŒ"""
              cmd = [
                  'psql', '-h', '192.168.60.64', '-p', '5432', '-U', 'postgres', 
                  '-d', 'solmakasedb', '-t', '-c', 
                  "SELECT id FROM companywworkspace LIMIT 1;"
              ]
              result = subprocess.run(cmd, capture_output=True, text=True, env=dict(os.environ, PGPASSWORD='qaz123'))
              return result.stdout.strip() or '1'  # ê¸°ë³¸ê°’ 1

          def save_vm_info(vm_data, workspace_id):
              """VM ì •ë³´ë¥¼ DBì— ì €ìž¥"""
              hostname = vm_data['hostname']
              
              # ê¸°ì¡´ VM í™•ì¸
              check_sql = f"SELECT id FROM vm WHERE name = '{hostname}'"
              cmd = [
                  'psql', '-h', '192.168.60.64', '-p', '5432', '-U', 'postgres', 
                  '-d', 'solmakasedb', '-t', '-c', check_sql
              ]
              result = subprocess.run(cmd, capture_output=True, text=True, env=dict(os.environ, PGPASSWORD='qaz123'))
              vm_id = result.stdout.strip()
              
              now = datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")
              
              if vm_id:
                  # VM ì—…ë°ì´íŠ¸
                  update_sql = f"""
                  UPDATE vm SET 
                      os_type = '{vm_data['os_type']}',
                      cpu_cores = {vm_data['cpu_cores']},
                      memory_gb = {vm_data['memory_gb']},
                      storage_gb = {vm_data['storage_gb']},
                      status = '{vm_data['status']}',
                      total_usage_hrs = total_usage_hrs + 1
                  WHERE id = {vm_id}
                  """
                  cmd = [
                      'psql', '-h', '192.168.60.64', '-p', '5432', '-U', 'postgres', 
                      '-d', 'solmakasedb', '-c', update_sql
                  ]
                  subprocess.run(cmd, env=dict(os.environ, PGPASSWORD='qaz123'))
                  print(f"âœ… VM '{hostname}' ì •ë³´ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.")
              else:
                  # ìƒˆ VM ì¶”ê°€
                  insert_sql = f"""
                  INSERT INTO vm (
                      name, os_type, cpu_cores, memory_gb, storage_gb, 
                      status, total_usage_hrs, created_at, company_workspace_id
                  ) VALUES (
                      '{hostname}', '{vm_data['os_type']}', {vm_data['cpu_cores']}, 
                      {vm_data['memory_gb']}, {vm_data['storage_gb']}, '{vm_data['status']}', 
                      0, '{now}', {workspace_id}
                  ) RETURNING id
                  """
                  cmd = [
                      'psql', '-h', '192.168.60.64', '-p', '5432', '-U', 'postgres', 
                      '-d', 'solmakasedb', '-t', '-c', insert_sql
                  ]
                  result = subprocess.run(cmd, capture_output=True, text=True, env=dict(os.environ, PGPASSWORD='qaz123'))
                  new_vm_id = result.stdout.strip()
                  
                  # VM ë„¤íŠ¸ì›Œí¬ ì •ë³´ ì¶”ê°€
                  if new_vm_id:
                      network_sql = f"""
                      INSERT INTO vm_network (vm_id, ip_address, network_type)
                      VALUES ({new_vm_id}, '{vm_data['ip_address']}', 'internal')
                      """
                      cmd = [
                          'psql', '-h', '192.168.60.64', '-p', '5432', '-U', 'postgres', 
                          '-d', 'solmakasedb', '-c', network_sql
                      ]
                      subprocess.run(cmd, env=dict(os.environ, PGPASSWORD='qaz123'))
                      print(f"âœ… ìƒˆ VM '{hostname}' ë° ë„¤íŠ¸ì›Œí¬ ì •ë³´ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.")

          # ë©”ì¸ ì‹¤í–‰
          workspace_id = get_workspace_id()
          vm_files = glob.glob('/tmp/ansible-vminfo/*.json')

          for vm_file in vm_files:
              with open(vm_file, 'r') as f:
                  try:
                      vm_data = json.load(f)
                      save_vm_info(vm_data, workspace_id)
                  except json.JSONDecodeError:
                      print(f"âŒ ì˜¤ë¥˜: {vm_file} íŒŒì¼ì„ íŒŒì‹±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
                  except Exception as e:
                      print(f"âŒ ì˜¤ë¥˜ ë°œìƒ: {str(e)}")

          print("âœ… ëª¨ë“  VM ì •ë³´ ì²˜ë¦¬ ì™„ë£Œ")
          EOF
          
          chmod +x /tmp/ansible-vminfo/save_to_db.py

      - name: Create Temporary Directory on Ansible Master Server (192.168.50.11)
        run: |
          echo "ðŸ”§ Ansible ë§ˆìŠ¤í„° ì„œë²„ì— ìž„ì‹œ ë””ë ‰í† ë¦¬ ìƒì„± ì¤‘..."
          ssh -o StrictHostKeyChecking=no awx@192.168.50.11 "mkdir -p /tmp/ansible-vminfo"

      - name: Fetch Ansible Files from DB Server
        run: |
          echo "ðŸš€ DB ì„œë²„ì—ì„œ Ansible íŒŒì¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘..."
          
          # ìž„ì‹œ ë””ë ‰í† ë¦¬ ìƒì„±
          mkdir -p /tmp/ansible-deploy

          # ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ê°€ì ¸ì˜¤ê¸°
          scp -o StrictHostKeyChecking=no postgres@${{ env.SELECTED_DB_SERVER }}:${{ env.DEPLOY_SCRIPT }} /tmp/ansible-deploy/deploy.sh
          
          # Ansible í…œí”Œë¦¿ ë””ë ‰í† ë¦¬ì—ì„œ í•„ìš”í•œ íŒŒì¼ ê°€ì ¸ì˜¤ê¸°
          scp -o StrictHostKeyChecking=no -r postgres@${{ env.SELECTED_DB_SERVER }}:${{ env.ANSIBLE_TEMPLATE_DIR }}/inventory /tmp/ansible-deploy/
          scp -o StrictHostKeyChecking=no -r postgres@${{ env.SELECTED_DB_SERVER }}:${{ env.ANSIBLE_TEMPLATE_DIR }}/playbooks /tmp/ansible-deploy/

      - name: Copy Ansible Files to Master Server
        run: |
          echo "ðŸš€ Ansible íŒŒì¼ì„ ë§ˆìŠ¤í„° ì„œë²„ë¡œ ë³µì‚¬ ì¤‘..."
          
          # ë°°í¬ì— í•„ìš”í•œ íŒŒì¼ ë³µì‚¬
          scp -o StrictHostKeyChecking=no -r /tmp/ansible-deploy/* awx@192.168.50.11:/tmp/ansible-deploy/
          
          # VM ì •ë³´ ìˆ˜ì§‘ í”Œë ˆì´ë¶ ë³µì‚¬
          scp -o StrictHostKeyChecking=no /tmp/ansible-vminfo/collect_vm_info.yml awx@192.168.50.11:/tmp/ansible-vminfo/

      - name: Execute Ansible Deployment Script
        run: |
          echo "ðŸš€ Ansible ë§ˆìŠ¤í„° ì„œë²„ì—ì„œ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì¤‘..."
          ssh -o StrictHostKeyChecking=no awx@192.168.50.11 "chmod +x /tmp/ansible-deploy/deploy.sh && /tmp/ansible-deploy/deploy.sh"
          
          DEPLOYMENT_STATUS=$?
          if [ $DEPLOYMENT_STATUS -eq 0 ]; then
            echo "âœ… ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬ì— ì„±ê³µí–ˆìŠµë‹ˆë‹¤!"
          else
            echo "âŒ ë°°í¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìƒíƒœ ì½”ë“œ: $DEPLOYMENT_STATUS"
            exit $DEPLOYMENT_STATUS
          fi

      - name: Run VM Info Collection Playbook
        run: |
          echo "ðŸ” VM ì •ë³´ ìˆ˜ì§‘ í”Œë ˆì´ë¶ ì‹¤í–‰ ì¤‘..."
          ssh -o StrictHostKeyChecking=no awx@192.168.50.11 "ansible-playbook -i /tmp/ansible-deploy/inventory/hosts /tmp/ansible-vminfo/collect_vm_info.yml"

      - name: Fetch VM Info JSON Files from Master
        run: |
          echo "ðŸ“¤ ë§ˆìŠ¤í„° ì„œë²„ì—ì„œ ìˆ˜ì§‘ëœ VM ì •ë³´ ê°€ì ¸ì˜¤ëŠ” ì¤‘..."
          scp -o StrictHostKeyChecking=no -r awx@192.168.50.11:/tmp/ansible-vminfo/*.json /tmp/ansible-vminfo/

      - name: Save VM Info to Database
        run: |
          echo "ðŸ’¾ VM ì •ë³´ë¥¼ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ìž¥ ì¤‘..."
          python3 /tmp/ansible-vminfo/save_to_db.py

      - name: Cleanup
        run: |
          echo "ðŸ§¹ ìž„ì‹œ íŒŒì¼ ì •ë¦¬ ì¤‘..."
          rm -rf /tmp/ansible-deploy
          rm -rf /tmp/ansible-vminfo
          ssh -o StrictHostKeyChecking=no awx@192.168.50.11 "rm -rf /tmp/ansible-deploy /tmp/ansible-vminfo"
          echo "âœ… ì •ë¦¬ ì™„ë£Œ"
